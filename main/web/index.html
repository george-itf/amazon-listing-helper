<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amazon Listing Helper</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="stylesheet" href="/css/tailwind.css">
</head>
<body class="bg-gray-50">
  <div class="flex h-screen">
    <nav class="w-64 bg-white border-r border-gray-200 flex-shrink-0">
      <div class="p-6 border-b border-gray-200">
        <h1 class="text-xl font-bold text-gray-900">Listing Helper</h1>
        <p class="text-xs text-gray-500 mt-1">FBM Edition</p>
      </div>
      <div class="py-4">
        <a href="#" onclick="showPage('dashboard')" id="nav-dashboard" class="block px-6 py-3 bg-gray-100 border-r-4 border-blue-600">Dashboard</a>
        <a href="#" onclick="showPage('listings')" id="nav-listings" class="block px-6 py-3 hover:bg-gray-50">Listings</a>
        <a href="#" onclick="showPage('pricing')" id="nav-pricing" class="block px-6 py-3 hover:bg-gray-50">Pricing</a>
        <a href="#" onclick="showPage('alerts')" id="nav-alerts" class="block px-6 py-3 hover:bg-gray-50">Alerts</a>
        <a href="#" onclick="showPage('shipping')" id="nav-shipping" class="block px-6 py-3 hover:bg-gray-50">Shipping</a>
        <a href="#" onclick="showPage('optimize')" id="nav-optimize" class="block px-6 py-3 hover:bg-gray-50">Optimize</a>
        <a href="#" onclick="showPage('ai')" id="nav-ai" class="block px-6 py-3 hover:bg-gray-50">AI Assist</a>
        <a href="#" onclick="showPage('tasks')" id="nav-tasks" class="block px-6 py-3 hover:bg-gray-50">Tasks</a>
        <a href="#" onclick="showPage('changes')" id="nav-changes" class="block px-6 py-3 hover:bg-gray-50">Push to Amazon</a>
        <a href="#" onclick="showPage('rules')" id="nav-rules" class="block px-6 py-3 hover:bg-gray-50">Rules</a>
        <a href="#" onclick="showPage('bom')" id="nav-bom" class="block px-6 py-3 hover:bg-gray-50">BOM & Costs</a>
        <a href="#" onclick="showPage('opportunities')" id="nav-opportunities" class="block px-6 py-3 hover:bg-gray-50">Opportunities</a>
        <a href="#" onclick="showPage('forecast')" id="nav-forecast" class="block px-6 py-3 hover:bg-gray-50">Forecasting</a>
        <a href="#" onclick="showPage('reports')" id="nav-reports" class="block px-6 py-3 hover:bg-gray-50">Reports</a>
        <a href="#" onclick="showPage('generator')" id="nav-generator" class="block px-6 py-3 hover:bg-gray-50">Listing Generator</a>
        <a href="#" onclick="showPage('webhooks')" id="nav-webhooks" class="block px-6 py-3 hover:bg-gray-50">Webhooks</a>
        <a href="#" onclick="showPage('widgets')" id="nav-widgets" class="block px-6 py-3 hover:bg-gray-50">Dashboard Setup</a>
        <a href="#" onclick="showPage('settings')" id="nav-settings" class="block px-6 py-3 hover:bg-gray-50">Settings</a>
      </div>
    </nav>
    <main class="flex-1 p-8 overflow-auto">
      <div id="page-dashboard">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Dashboard</h2>
          <div><button onclick="syncListings()" id="btn-sync" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Sync Now</button><span id="sync-msg" class="ml-4 text-sm"></span></div>
        </div>
        <div id="status-box" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">Loading...</div>
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Total SKUs</p><p id="s-total" class="text-2xl font-bold">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Active</p><p id="s-active" class="text-2xl font-bold text-green-600">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Avg Score</p><p id="s-avgscore" class="text-2xl font-bold text-blue-600">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Needs Work</p><p id="s-needswork" class="text-2xl font-bold text-orange-600">-</p></div>
        </div>
        <div class="grid grid-cols-3 gap-4">
          <div class="bg-green-50 p-5 rounded border border-green-200"><p class="text-green-700 text-sm">Excellent (80+)</p><p id="s-excellent" class="text-2xl font-bold text-green-700">-</p></div>
          <div class="bg-yellow-50 p-5 rounded border border-yellow-200"><p class="text-yellow-700 text-sm">Good (60-79)</p><p id="s-good" class="text-2xl font-bold text-yellow-700">-</p></div>
          <div class="bg-red-50 p-5 rounded border border-red-200"><p class="text-red-700 text-sm">Needs Work (&lt;60)</p><p id="s-poor" class="text-2xl font-bold text-red-700">-</p></div>
        </div>
        <div id="dashboard-enhanced" class="mt-6"></div>

        <!-- Enhanced Scoring Dashboard -->
        <div class="grid grid-cols-2 gap-6 mt-6">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Score Summary (5 Components)</h3>
            <div id="score-summary">Loading...</div>
          </div>
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4 text-red-700">⚠️ Compliance Issues</h3>
            <div id="compliance-issues">Loading...</div>
          </div>
        </div>
      </div>
      <div id="page-listings" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Listings</h2>
          <select id="filter-score" onchange="renderListings()" class="border rounded px-3 py-2 text-sm">
            <option value="all">All Scores</option>
            <option value="excellent">Excellent (80+)</option>
            <option value="good">Good (60-79)</option>
            <option value="poor">Needs Work (&lt;60)</option>
          </select>
        </div>
        <div id="listings-container" class="bg-white rounded border overflow-hidden"></div>
      </div>
      <div id="page-pricing" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Pricing & Profits</h2>
        </div>
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">With Costs</p><p id="p-withcosts" class="text-2xl font-bold">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Profitable</p><p id="p-profitable" class="text-2xl font-bold text-green-600">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Unprofitable</p><p id="p-unprofitable" class="text-2xl font-bold text-red-600">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Avg Margin</p><p id="p-avgmargin" class="text-2xl font-bold text-blue-600">-</p></div>
        </div>
        <div id="pricing-container" class="bg-white rounded border overflow-hidden"></div>
      </div>
      <div id="page-detail" class="hidden">
        <div class="mb-6"><button onclick="showPage('listings')" class="text-blue-600 hover:underline">&larr; Back</button></div>
        <div id="detail-container"></div>
      </div>
      <div id="page-cost-edit" class="hidden">
        <div class="mb-6"><button onclick="showPage('pricing')" class="text-blue-600 hover:underline">&larr; Back to Pricing</button></div>
        <div id="cost-edit-container"></div>
      </div>
      
      <div id="page-alerts" class="hidden"><div class="flex items-center justify-between mb-6"><h2 class="text-2xl font-bold">Alerts</h2><div><button onclick="runAutomation()" class="bg-blue-600 text-white px-4 py-2 rounded mr-2">Check Now</button><button onclick="markAllRead()" class="border px-4 py-2 rounded">Mark All Read</button></div></div><div class="grid grid-cols-4 gap-4 mb-6"><div class="bg-red-50 p-5 rounded border border-red-200"><p class="text-red-700 text-sm">Critical</p><p id="alert-critical" class="text-2xl font-bold text-red-700">-</p></div><div class="bg-orange-50 p-5 rounded border border-orange-200"><p class="text-orange-700 text-sm">High</p><p id="alert-high" class="text-2xl font-bold text-orange-700">-</p></div><div class="bg-yellow-50 p-5 rounded border border-yellow-200"><p class="text-yellow-700 text-sm">Medium</p><p id="alert-medium" class="text-2xl font-bold text-yellow-700">-</p></div><div class="bg-blue-50 p-5 rounded border border-blue-200"><p class="text-blue-700 text-sm">Low</p><p id="alert-low" class="text-2xl font-bold text-blue-700">-</p></div></div><div id="alerts-container" class="bg-white rounded border"></div></div><div id="page-shipping" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Shipping Calculator</h2>
        <div class="grid grid-cols-2 gap-6">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Calculate Rate</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
              <div><label class="block text-sm mb-1">Weight (g)</label><input type="number" id="ship-weight" value="500" class="w-full border rounded px-3 py-2"></div>
              <div><label class="block text-sm mb-1">Length (mm)</label><input type="number" id="ship-length" value="200" class="w-full border rounded px-3 py-2"></div>
              <div><label class="block text-sm mb-1">Width (mm)</label><input type="number" id="ship-width" value="150" class="w-full border rounded px-3 py-2"></div>
              <div><label class="block text-sm mb-1">Height (mm)</label><input type="number" id="ship-height" value="50" class="w-full border rounded px-3 py-2"></div>
            </div>
            <button onclick="calcShipping()" class="bg-blue-600 text-white px-4 py-2 rounded">Calculate</button>
            <div id="ship-result" class="mt-4"></div>
          </div>
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Royal Mail Rates</h3>
            <div class="space-y-2 text-sm">
              <div class="p-2 bg-gray-50 rounded"><b>Large Letter</b> max 353x250x25mm, 750g</div>
              <div class="p-2 bg-gray-50 rounded"><b>Small Parcel</b> max 450x350x160mm, 2kg</div>
              <div class="p-2 bg-gray-50 rounded"><b>Medium Parcel</b> max 610x460x460mm, 20kg</div>
            </div>
          </div>
        </div>
      </div>
      <div id="page-optimize" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Price Optimization</h2>
          <button onclick="loadOptimize()" class="bg-blue-600 text-white px-4 py-2 rounded">Refresh</button>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-red-50 p-5 rounded border border-red-200"><p class="text-red-700 text-sm">High Priority</p><p id="opt-high" class="text-2xl font-bold text-red-700">-</p></div>
          <div class="bg-yellow-50 p-5 rounded border border-yellow-200"><p class="text-yellow-700 text-sm">Medium</p><p id="opt-medium" class="text-2xl font-bold text-yellow-700">-</p></div>
          <div class="bg-blue-50 p-5 rounded border border-blue-200"><p class="text-blue-700 text-sm">Low</p><p id="opt-low" class="text-2xl font-bold text-blue-700">-</p></div>
        </div>
        <div id="optimize-container" class="bg-white rounded border"></div>
      </div>
      <div id="page-opt-detail" class="hidden">
        <button onclick="showPage('optimize')" class="text-blue-600 mb-4">Back</button>
        <div id="opt-detail"></div>
      </div>
      <div id="page-ai" class="hidden">
        <h2 class="text-2xl font-bold mb-6">AI Recommendations</h2>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
          <h3 class="font-semibold mb-4">Listings Needing Attention</h3>
          <div id="ai-bulk-list">Loading...</div>
        </div>
        <div id="ai-detail" class="bg-white rounded-lg shadow p-6 hidden">
          <h3 class="font-semibold mb-4">Recommendations for: <span id="ai-sku"></span></h3>
          <div id="ai-recommendations"></div>
        </div>
      </div>
      <div id="page-tasks" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Task Board</h2>
          <div>
            <button onclick="generateTasks()" class="bg-green-600 text-white px-4 py-2 rounded mr-2 hover:bg-green-700">Auto-Generate</button>
            <button onclick="showAddTask()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Task</button>
          </div>
        </div>
        <div id="task-stats" class="grid grid-cols-4 gap-4 mb-6"></div>
        <div id="kanban-board" class="flex gap-4 overflow-x-auto pb-4"></div>
        <div id="add-task-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 class="text-lg font-bold mb-4">Add New Task</h3>
            <div class="space-y-4">
              <div><label class="block text-sm font-medium mb-1">Title</label><input type="text" id="task-title" class="w-full border rounded px-3 py-2"></div>
              <div><label class="block text-sm font-medium mb-1">Description</label><textarea id="task-desc" class="w-full border rounded px-3 py-2" rows="3"></textarea></div>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-sm font-medium mb-1">Type</label><select id="task-type" class="w-full border rounded px-3 py-2"><option value="optimization">Optimization</option><option value="pricing">Pricing</option><option value="content">Content</option><option value="images">Images</option><option value="competitive">Competitive</option><option value="other">Other</option></select></div>
                <div><label class="block text-sm font-medium mb-1">Priority</label><select id="task-priority" class="w-full border rounded px-3 py-2"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>
              </div>
              <div><label class="block text-sm font-medium mb-1">SKU (optional)</label><input type="text" id="task-sku" class="w-full border rounded px-3 py-2"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
              <button onclick="hideAddTask()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
              <button onclick="saveTask()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
            </div>
          </div>
        </div>
      </div>
      <div id="page-changes" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Push to Amazon</h2>
          <button onclick="submitChanges()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Submit All Pending</button>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-6">
          <p class="text-yellow-800"><strong>Note:</strong> Changes are queued locally and submitted to Amazon via SP-API Feeds. Price changes may take 15-30 minutes to reflect on Amazon.</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
          <h3 class="font-semibold mb-4">Queue Price Change</h3>
          <div class="grid grid-cols-3 gap-4">
            <div><label class="block text-sm mb-1">SKU</label><input type="text" id="change-sku" class="w-full border rounded px-3 py-2" placeholder="Enter SKU"></div>
            <div><label class="block text-sm mb-1">New Price (£)</label><input type="number" step="0.01" id="change-price" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm mb-1">Reason</label><input type="text" id="change-reason" class="w-full border rounded px-3 py-2" placeholder="Optional"></div>
          </div>
          <button onclick="queuePrice()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Queue Change</button>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="font-semibold mb-4">Pending Changes</h3>
          <div id="changes-list">Loading...</div>
        </div>
      </div>
      <div id="page-rules" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Automation Rules</h2>
          <button onclick="showAddRule()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Rule</button>
        </div>
        <div class="bg-white rounded-lg shadow p-6 mb-6">
          <h3 class="font-semibold mb-4">Active Rules</h3>
          <div id="rules-list">Loading...</div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
          <h3 class="font-semibold mb-4">Rule Templates</h3>
          <div id="rule-templates" class="grid grid-cols-2 gap-4"></div>
        </div>
        <div id="add-rule-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Create Automation Rule</h3>
            <div class="space-y-4">
              <div><label class="block text-sm font-medium mb-1">Rule Name</label><input type="text" id="rule-name" class="w-full border rounded px-3 py-2"></div>
              <div><label class="block text-sm font-medium mb-1">Trigger Type</label><select id="rule-trigger" class="w-full border rounded px-3 py-2"><option value="threshold">Threshold (score, margin, etc)</option><option value="competitive">Competitive Event</option></select></div>
              <div id="trigger-config"></div>
              <div><label class="block text-sm font-medium mb-1">Action</label><select id="rule-action" class="w-full border rounded px-3 py-2"><option value="alert">Create Alert</option><option value="task">Create Task</option></select></div>
              <div><label class="block text-sm font-medium mb-1">Severity</label><select id="rule-severity" class="w-full border rounded px-3 py-2"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
              <button onclick="hideAddRule()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
              <button onclick="saveRule()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Rule</button>
            </div>
          </div>
        </div>
      </div>

      <!-- BOM & Cost Management Page -->
      <div id="page-bom" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">BOM & Cost Management</h2>
          <div class="space-x-2">
            <button onclick="showSupplierModal()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Add Supplier</button>
            <button onclick="showComponentModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Add Component</button>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 mb-6">
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Total Suppliers</p><p id="bom-suppliers" class="text-2xl font-bold">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Total Components</p><p id="bom-components" class="text-2xl font-bold text-blue-600">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">SKUs with BOM</p><p id="bom-skus" class="text-2xl font-bold text-green-600">-</p></div>
        </div>
        <div class="grid grid-cols-2 gap-6">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Suppliers</h3>
            <div id="suppliers-list" class="space-y-2 max-h-64 overflow-y-auto">Loading...</div>
          </div>
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Components <span class="text-xs text-gray-500 font-normal">(reusable across all products)</span></h3>
            <div id="components-list" class="space-y-2 max-h-64 overflow-y-auto">Loading...</div>
          </div>
        </div>
        <div class="mt-6 bg-white rounded border p-6">
          <h3 class="font-semibold mb-4">Bill of Materials by SKU</h3>
          <div class="mb-4">
            <select id="bom-sku-select" onchange="loadBOMForSKU()" class="border rounded px-3 py-2 w-64"><option value="">Select a SKU...</option></select>
          </div>
          <div id="bom-editor" class="hidden">
            <div class="grid grid-cols-3 gap-4 mb-4">
              <div>
                <h4 class="font-medium mb-2">Components in this BOM</h4>
                <div id="bom-components-list" class="space-y-2 max-h-48 overflow-y-auto border rounded p-3"></div>
              </div>
              <div>
                <h4 class="font-medium mb-2">Add Component to BOM</h4>
                <div class="border rounded p-3">
                  <select id="bom-add-component" class="w-full border rounded px-2 py-1 text-sm mb-2"><option value="">Select component...</option></select>
                  <div class="flex gap-2">
                    <input type="number" id="bom-add-qty" placeholder="Qty" value="1" min="1" step="1" class="w-20 border rounded px-2 py-1 text-sm">
                    <button onclick="addComponentToBOM()" class="flex-1 bg-green-600 text-white px-2 py-1 rounded text-sm hover:bg-green-700">Add</button>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">Components can be reused across multiple products</p>
                </div>
              </div>
              <div>
                <h4 class="font-medium mb-2">Cost Breakdown</h4>
                <div id="bom-cost-breakdown" class="space-y-2 border rounded p-3"></div>
              </div>
            </div>
            <div class="grid grid-cols-4 gap-4">
              <div><label class="block text-sm mb-1">Labor Cost (£)</label><input type="number" id="bom-labor" step="0.01" class="w-full border rounded px-3 py-2"></div>
              <div><label class="block text-sm mb-1">Packaging (£)</label><input type="number" id="bom-packaging" step="0.01" class="w-full border rounded px-3 py-2"></div>
              <div><label class="block text-sm mb-1">Overhead (%)</label><input type="number" id="bom-overhead" step="0.1" class="w-full border rounded px-3 py-2"></div>
              <div class="flex items-end"><button onclick="saveBOMData()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">Save BOM</button></div>
            </div>
          </div>
        </div>
        <div class="mt-6 bg-white rounded border p-6">
          <h3 class="font-semibold mb-4">Component Usage Across Products</h3>
          <div id="component-usage-list" class="grid grid-cols-2 gap-4 max-h-64 overflow-y-auto">Loading...</div>
        </div>
      </div>

      <!-- Opportunities Page -->
      <div id="page-opportunities" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Opportunities</h2>
          <button onclick="loadOpportunities()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Refresh</button>
        </div>
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Total Opportunities</p><p id="opp-total" class="text-2xl font-bold">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Quick Wins</p><p id="opp-quickwins" class="text-2xl font-bold text-green-600">-</p></div>
          <div class="bg-purple-50 p-5 rounded border border-purple-200"><p class="text-purple-700 text-sm">High Priority</p><p id="opp-high" class="text-2xl font-bold text-purple-700">-</p></div>
          <div class="bg-blue-50 p-5 rounded border border-blue-200"><p class="text-blue-700 text-sm">Avg Opp Score</p><p id="opp-avg" class="text-2xl font-bold text-blue-700">-</p></div>
        </div>
        <div class="grid grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Quick Wins (Low Effort)</h3>
            <div id="quick-wins-list" class="space-y-3 max-h-80 overflow-y-auto">Loading...</div>
          </div>
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Bundle Opportunities</h3>
            <div id="bundles-list" class="space-y-3 max-h-80 overflow-y-auto">Loading...</div>
          </div>
        </div>
        <div class="bg-white rounded border p-6 mb-6">
          <h3 class="font-semibold mb-4">Seasonal Opportunities</h3>
          <div id="seasonal-info" class="mb-4"></div>
          <div id="seasonal-list" class="space-y-2 max-h-48 overflow-y-auto"></div>
        </div>
        <div class="bg-white rounded border p-6">
          <h3 class="font-semibold mb-4">All Opportunities (by Priority)</h3>
          <div id="opportunities-list" class="space-y-3 max-h-96 overflow-y-auto">Loading...</div>
        </div>
      </div>

      <!-- Forecasting Page -->
      <div id="page-forecast" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Demand Forecasting</h2>
          <button onclick="loadBulkForecast()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Refresh Forecasts</button>
        </div>
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">SKUs with Data</p><p id="fc-with-data" class="text-2xl font-bold">-</p></div>
          <div class="bg-green-50 p-5 rounded border border-green-200"><p class="text-green-700 text-sm">Growing</p><p id="fc-growing" class="text-2xl font-bold text-green-700">-</p></div>
          <div class="bg-yellow-50 p-5 rounded border border-yellow-200"><p class="text-yellow-700 text-sm">Stable</p><p id="fc-stable" class="text-2xl font-bold text-yellow-700">-</p></div>
          <div class="bg-red-50 p-5 rounded border border-red-200"><p class="text-red-700 text-sm">Declining</p><p id="fc-declining" class="text-2xl font-bold text-red-700">-</p></div>
        </div>
        <div class="grid grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Top Sellers (30-day Forecast)</h3>
            <div id="top-sellers-list" class="space-y-2 max-h-64 overflow-y-auto">Loading...</div>
          </div>
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Forecast Detail</h3>
            <select id="forecast-sku-select" onchange="loadSKUForecast()" class="border rounded px-3 py-2 w-full mb-4"><option value="">Select a SKU...</option></select>
            <div id="forecast-detail" class="space-y-2"></div>
          </div>
        </div>
        <div class="bg-white rounded border p-6">
          <h3 class="font-semibold mb-4">Restock Recommendations</h3>
          <div class="grid grid-cols-3 gap-4 mb-4">
            <div><label class="block text-sm mb-1">Current Stock</label><input type="number" id="restock-stock" value="100" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm mb-1">Lead Time (days)</label><input type="number" id="restock-lead" value="7" class="w-full border rounded px-3 py-2"></div>
            <div class="flex items-end"><button onclick="checkRestock()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 w-full">Check Restock Need</button></div>
          </div>
          <div id="restock-result"></div>
        </div>
      </div>

<!-- Reports Page -->
      <div id="page-reports" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Reports</h2>
          <button onclick="showGenerateReportModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Generate Report</button>
        </div>
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Templates</p><p id="rpt-templates" class="text-2xl font-bold">8</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Generated</p><p id="rpt-generated" class="text-2xl font-bold text-blue-600">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Scheduled</p><p id="rpt-scheduled" class="text-2xl font-bold text-green-600">-</p></div>
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Last Generated</p><p id="rpt-last" class="text-sm text-gray-600">-</p></div>
        </div>
        <div class="grid grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Report Templates</h3>
            <div id="report-templates-list" class="space-y-3 max-h-80 overflow-y-auto">Loading...</div>
          </div>
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Scheduled Reports</h3>
            <div id="scheduled-reports-list" class="space-y-3 max-h-80 overflow-y-auto">Loading...</div>
          </div>
        </div>
        <div class="bg-white rounded border p-6">
          <h3 class="font-semibold mb-4">Recent Reports</h3>
          <div id="recent-reports-list" class="space-y-2 max-h-64 overflow-y-auto">Loading...</div>
        </div>
        <div id="generate-report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg p-6 w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4">Generate Report</h3>
            <div class="space-y-4">
              <div><label class="block text-sm font-medium mb-1">Report Type</label><select id="report-template" class="w-full border rounded px-3 py-2"><option value="portfolio_overview">Portfolio Overview</option><option value="profit_analysis">Profit Analysis</option><option value="competitive_report">Competitive Report</option><option value="score_report">Score Report</option><option value="alerts_report">Alerts Report</option><option value="tasks_report">Tasks Report</option><option value="forecast_report">Forecast Report</option><option value="opportunities_report">Opportunities Report</option></select></div>
              <div><label class="block text-sm font-medium mb-1">Output Format</label><select id="report-format" class="w-full border rounded px-3 py-2"><option value="json">JSON</option><option value="csv">CSV</option><option value="html">HTML</option></select></div>
              <div><label class="flex items-center"><input type="checkbox" id="report-schedule" class="mr-2"><span class="text-sm">Schedule this report</span></label></div>
              <div id="schedule-options" class="hidden space-y-2">
                <div><label class="block text-sm font-medium mb-1">Frequency</label><select id="report-frequency" class="w-full border rounded px-3 py-2"><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="monthly">Monthly</option></select></div>
              </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
              <button onclick="hideGenerateReportModal()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
              <button onclick="generateReport()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Generate</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Webhooks Page -->
      <div id="page-webhooks" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Webhooks & Integrations</h2>
          <button onclick="showAddWebhookModal()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">+ Add Webhook</button>
        </div>
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-white p-5 rounded border"><p class="text-gray-500 text-sm">Total Webhooks</p><p id="wh-total" class="text-2xl font-bold">-</p></div>
          <div class="bg-green-50 p-5 rounded border border-green-200"><p class="text-green-700 text-sm">Active</p><p id="wh-active" class="text-2xl font-bold text-green-700">-</p></div>
          <div class="bg-blue-50 p-5 rounded border border-blue-200"><p class="text-blue-700 text-sm">Executions (24h)</p><p id="wh-executions" class="text-2xl font-bold text-blue-700">-</p></div>
          <div class="bg-red-50 p-5 rounded border border-red-200"><p class="text-red-700 text-sm">Failures (24h)</p><p id="wh-failures" class="text-2xl font-bold text-red-700">-</p></div>
        </div>
        <div class="bg-white rounded border p-6 mb-6">
          <h3 class="font-semibold mb-4">Configured Webhooks</h3>
          <div id="webhooks-list" class="space-y-3">Loading...</div>
        </div>
        <div class="bg-white rounded border p-6">
          <h3 class="font-semibold mb-4">Recent Webhook Executions</h3>
          <div id="webhook-executions-list" class="space-y-2 max-h-64 overflow-y-auto">Loading...</div>
        </div>
        <div id="add-webhook-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div class="bg-white rounded-lg p-6 w-full max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold mb-4">Add Webhook</h3>
            <div class="space-y-4">
              <div><label class="block text-sm font-medium mb-1">Name</label><input type="text" id="wh-name" class="w-full border rounded px-3 py-2" placeholder="My Webhook"></div>
              <div><label class="block text-sm font-medium mb-1">URL</label><input type="url" id="wh-url" class="w-full border rounded px-3 py-2" placeholder="https://example.com/webhook"></div>
              <div><label class="block text-sm font-medium mb-1">Events</label>
                <div class="space-y-1">
                  <label class="flex items-center"><input type="checkbox" value="alert_created" class="wh-event mr-2"><span class="text-sm">Alert Created</span></label>
                  <label class="flex items-center"><input type="checkbox" value="task_created" class="wh-event mr-2"><span class="text-sm">Task Created</span></label>
                  <label class="flex items-center"><input type="checkbox" value="price_change" class="wh-event mr-2"><span class="text-sm">Price Change</span></label>
                  <label class="flex items-center"><input type="checkbox" value="score_change" class="wh-event mr-2"><span class="text-sm">Score Change</span></label>
                  <label class="flex items-center"><input type="checkbox" value="sync_complete" class="wh-event mr-2"><span class="text-sm">Sync Complete</span></label>
                </div>
              </div>
              <div><label class="block text-sm font-medium mb-1">Authentication (optional)</label>
                <select id="wh-auth-type" class="w-full border rounded px-3 py-2 mb-2" onchange="toggleWebhookAuth()"><option value="none">None</option><option value="bearer">Bearer Token</option><option value="basic">Basic Auth</option><option value="api_key">API Key Header</option></select>
                <div id="wh-auth-config" class="hidden space-y-2">
                  <input type="text" id="wh-auth-value" class="w-full border rounded px-3 py-2" placeholder="Token or Key">
                </div>
              </div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
              <button onclick="hideAddWebhookModal()" class="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
              <button onclick="saveWebhook()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save Webhook</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard Widgets Page -->
      <div id="page-widgets" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Dashboard Setup</h2>
          <div class="space-x-2">
            <button onclick="resetDashboardLayout()" class="border px-4 py-2 rounded hover:bg-gray-50">Reset to Default</button>
            <button onclick="saveDashboardLayout()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Save Layout</button>
          </div>
        </div>
        <div class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-6">
          <p class="text-yellow-800 text-sm">Customize your dashboard by selecting which widgets to display. Changes will be saved automatically.</p>
        </div>
        <div class="grid grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Available Widgets</h3>
            <div id="available-widgets" class="space-y-2 max-h-96 overflow-y-auto">Loading...</div>
          </div>
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Active Widgets (Drag to Reorder)</h3>
            <div id="active-widgets" class="space-y-2 min-h-64 max-h-96 overflow-y-auto border-2 border-dashed border-gray-200 rounded p-3">Loading...</div>
          </div>
        </div>
        <div class="bg-white rounded border p-6">
          <h3 class="font-semibold mb-4">Saved Layouts</h3>
          <div id="saved-layouts" class="grid grid-cols-4 gap-4">Loading...</div>
        </div>
      </div>

      <!-- Listing Generator Page -->
      <div id="page-generator" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-2xl font-bold">Listing Generator</h2>
        </div>
        <div class="grid grid-cols-3 gap-6">
          <!-- Input Section -->
          <div class="col-span-2 space-y-6">
            <!-- ASIN Input -->
            <div class="bg-white rounded border p-6">
              <h3 class="font-semibold mb-4">Generate from ASIN(s)</h3>
              <p class="text-sm text-gray-500 mb-3">Enter one or more ASINs to analyze and generate listing recommendations</p>
              <textarea id="gen-asins" class="w-full border rounded px-3 py-2 h-24" placeholder="Enter ASINs (one per line or comma-separated)&#10;e.g. B08XYZ1234&#10;B09ABC5678"></textarea>
              <div class="flex gap-2 mt-3">
                <button onclick="generateFromASINs()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Analyze ASINs</button>
                <button onclick="compareASINs()" class="border px-4 py-2 rounded hover:bg-gray-50">Compare Multiple</button>
              </div>
            </div>
            <!-- Component Input -->
            <div class="bg-white rounded border p-6">
              <h3 class="font-semibold mb-4">Generate from Product Components</h3>
              <p class="text-sm text-gray-500 mb-3">Define your product details to generate optimized listing content</p>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Brand Name</label>
                  <input type="text" id="gen-brand" class="w-full border rounded px-3 py-2" placeholder="Your Brand">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Product Name</label>
                  <input type="text" id="gen-name" class="w-full border rounded px-3 py-2" placeholder="Product Name">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Category</label>
                  <select id="gen-category" class="w-full border rounded px-3 py-2">
                    <option value="">Select Category</option>
                    <option value="tools">Power Tools</option>
                    <option value="hand_tools">Hand Tools</option>
                    <option value="fasteners">Fasteners & Hardware</option>
                    <option value="electrical">Electrical</option>
                    <option value="safety">Safety Equipment</option>
                    <option value="consumables">Consumables</option>
                    <option value="accessories">Tool Accessories</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Primary Material</label>
                  <input type="text" id="gen-material" class="w-full border rounded px-3 py-2" placeholder="e.g. Stainless Steel, Carbide">
                </div>
              </div>
              <div class="mt-4">
                <label class="block text-sm font-medium mb-1">Key Features (one per line)</label>
                <textarea id="gen-features" class="w-full border rounded px-3 py-2 h-24" placeholder="Heavy duty construction&#10;Precision engineered&#10;Professional grade"></textarea>
              </div>
              <div class="grid grid-cols-3 gap-4 mt-4">
                <div>
                  <label class="block text-sm font-medium mb-1">Quantity/Set Size</label>
                  <input type="text" id="gen-quantity" class="w-full border rounded px-3 py-2" placeholder="e.g. 10 Pack, Set of 5">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Size/Dimensions</label>
                  <input type="text" id="gen-size" class="w-full border rounded px-3 py-2" placeholder="e.g. 10mm, M8 x 50">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-1">Target Price (£)</label>
                  <input type="number" id="gen-price" class="w-full border rounded px-3 py-2" placeholder="19.99">
                </div>
              </div>
              <button onclick="generateFromComponents()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 mt-4">Generate Listing</button>
            </div>
          </div>
          <!-- Saved Listings Sidebar -->
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">Saved Drafts</h3>
            <div id="saved-generators" class="space-y-2 max-h-96 overflow-y-auto">Loading...</div>
          </div>
        </div>
        <!-- Results Section -->
        <div id="generator-results" class="mt-6 hidden">
          <div class="bg-white rounded border p-6">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-semibold">Generated Listing</h3>
              <div class="flex gap-2">
                <button onclick="copyGeneratedListing()" class="border px-3 py-1 rounded text-sm hover:bg-gray-50">Copy All</button>
                <button onclick="saveGeneratedListing()" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">Save Draft</button>
              </div>
            </div>
            <div id="gen-output" class="space-y-4"></div>
          </div>
        </div>
        <!-- Comparison Results -->
        <div id="comparison-results" class="mt-6 hidden">
          <div class="bg-white rounded border p-6">
            <h3 class="font-semibold mb-4">ASIN Comparison</h3>
            <div id="compare-output"></div>
          </div>
        </div>
      </div>

<div id="page-settings" class="hidden">
        <h2 class="text-2xl font-bold mb-6">Settings</h2>
        <div class="bg-white p-6 rounded border max-w-xl">
          <h3 class="font-semibold mb-4">SP-API Credentials</h3>
          <div id="cred-status" class="mb-4 p-3 bg-gray-100 rounded text-sm">Checking...</div>
          <div class="space-y-4">
            <div><label class="block text-sm font-medium mb-1">Client ID</label><input id="f-clientid" type="text" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm font-medium mb-1">Client Secret</label><input id="f-secret" type="password" class="w-full border rounded px-3 py-2"></div>
            <div><label class="block text-sm font-medium mb-1">Refresh Token</label><input id="f-token" type="password" class="w-full border rounded px-3 py-2"></div>
            <h3 class="font-semibold pt-4">Keepa API</h3>
            <div><label class="block text-sm font-medium mb-1">API Key</label><input id="f-keepa" type="password" class="w-full border rounded px-3 py-2"></div>
            <button onclick="saveSettings()" id="btn-save" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Save</button>
            <span id="save-msg" class="ml-3 text-sm"></span>
          </div>
        </div>
      </div>
    </main>
  </div>
<script>
let allListings = [], keepaData = {}, profitData = [];
function showPage(name) {
  document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
  document.getElementById('page-' + name).classList.remove('hidden');
  document.querySelectorAll('nav a').forEach(a => a.classList.remove('bg-gray-100', 'border-r-4', 'border-blue-600'));
  const nav = document.getElementById('nav-' + name);
  if (nav) nav.classList.add('bg-gray-100', 'border-r-4', 'border-blue-600');
  if (name === 'dashboard') { loadDashboard(); loadDashboardStats(); } if (name === 'shipping') calcShipping(); if (name === 'optimize') loadOptimize(); if (name === 'alerts') loadAlerts(); if (name === 'ai') loadAIBulk(); if (name === 'tasks') loadTasks(); if (name === 'changes') loadChanges(); if (name === 'rules') loadRules();
  if (name === 'settings') loadSettingsStatus();
  if (name === 'listings') loadListings();
  if (name === 'pricing') loadPricing();
  if (name === 'bom') loadBOMPage();
  if (name === 'opportunities') loadOpportunities();
  if (name === 'forecast') loadBulkForecast();
  if (name === 'reports') loadReportsPage();
  if (name === 'webhooks') loadWebhooksPage();
  if (name === 'widgets') loadWidgetsPage();
  if (name === 'generator') loadGeneratorPage();
}
async function loadDashboard() {
  try {
    const res = await fetch('/api/v1/dashboard');
    const { data } = await res.json();
    const box = document.getElementById('status-box');
    if (data.configured) {
      box.className = 'mb-6 p-4 bg-green-50 border border-green-200 rounded text-green-800';
      box.textContent = 'SP-API Connected - ' + data.scored + ' listings scored';
    } else {
      box.className = 'mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded text-yellow-800';
      box.textContent = 'Configure SP-API in Settings';
    }
    document.getElementById('s-total').textContent = data.totalSkus || 0;
    document.getElementById('s-active').textContent = data.active || 0;
    document.getElementById('s-avgscore').textContent = data.avgScore || 0;
    document.getElementById('s-needswork').textContent = data.scoreBreakdown?.needsWork || 0;
    document.getElementById('s-excellent').textContent = data.scoreBreakdown?.excellent || 0;
    document.getElementById('s-good').textContent = data.scoreBreakdown?.good || 0;
    document.getElementById('s-poor').textContent = data.scoreBreakdown?.needsWork || 0;

    // Load enhanced scoring components (from extra.js)
    if (typeof loadScoreSummary === 'function') loadScoreSummary('score-summary');
    if (typeof loadComplianceIssues === 'function') loadComplianceIssues('compliance-issues');
  } catch (e) { console.error(e); }
}
async function syncListings() {
  const btn = document.getElementById('btn-sync'), msg = document.getElementById('sync-msg');
  btn.disabled = true; btn.textContent = 'Syncing...';
  msg.textContent = 'Fetching...'; msg.className = 'ml-4 text-sm text-blue-600';
  try {
    const res = await fetch('/api/v1/sync', { method: 'POST' });
    const result = await res.json();
    if (result.success) { msg.className = 'ml-4 text-sm text-green-600'; msg.textContent = 'Synced ' + result.data.synced; loadDashboard(); }
    else { msg.className = 'ml-4 text-sm text-red-600'; msg.textContent = result.error; }
  } catch (e) { msg.className = 'ml-4 text-sm text-red-600'; msg.textContent = e.message; }
  btn.disabled = false; btn.textContent = 'Sync Now';
}
async function loadListings() {
  const container = document.getElementById('listings-container');
  container.innerHTML = '<p class="p-6 text-gray-500">Loading...</p>';
  try {
    const [lr, kr] = await Promise.all([fetch('/api/v1/listings'), fetch('/api/v1/keepa')]);
    allListings = (await lr.json()).data.items || [];
    keepaData = (await kr.json()).data?.data || {};
    renderListings();
  } catch (e) { container.innerHTML = '<p class="p-6 text-red-500">' + e.message + '</p>'; }
}
function renderListings() {
  const filter = document.getElementById('filter-score')?.value || 'all';
  let items = allListings;
  if (filter === 'excellent') items = items.filter(i => i.score >= 80);
  else if (filter === 'good') items = items.filter(i => i.score >= 60 && i.score < 80);
  else if (filter === 'poor') items = items.filter(i => i.score < 60);
  const container = document.getElementById('listings-container');
  if (!items.length) { container.innerHTML = '<p class="p-6 text-gray-500">No listings.</p>'; return; }
  let html = '<table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-3 text-left">Score</th><th class="p-3 text-left">Product</th><th class="p-3 text-right">Your Price</th><th class="p-3 text-right">Buy Box</th><th class="p-3 text-right">BSR</th><th class="p-3 text-right">Comp.</th></tr></thead><tbody>';
  items.forEach(item => {
    const score = item.score ?? '-';
    const sc = score >= 80 ? 'bg-green-100 text-green-800' : score >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800';
    const k = keepaData[item.asin] || {};
    const bb = k.buyBoxPrice ? '£' + k.buyBoxPrice.toFixed(2) : '-';
    const diff = k.buyBoxPrice && item.price ? item.price - k.buyBoxPrice : null;
    const pc = diff === null ? '' : diff > 0.01 ? 'text-red-600 font-medium' : diff < -0.01 ? 'text-green-600 font-medium' : 'text-blue-600 font-medium';
    html += '<tr class="border-t hover:bg-gray-50 cursor-pointer" onclick="showDetail(\'' + item.sku.replace(/'/g, "\\'") + '\')">';
    html += '<td class="p-3"><span class="px-2 py-1 rounded text-xs font-medium ' + sc + '">' + score + '</span></td>';
    html += '<td class="p-3 max-w-xs truncate">' + (item.title || '').substring(0, 50) + '</td>';
    html += '<td class="p-3 text-right ' + pc + '">£' + (item.price || 0).toFixed(2) + '</td>';
    html += '<td class="p-3 text-right">' + bb + '</td>';
    html += '<td class="p-3 text-right text-gray-500">' + (k.salesRank ? k.salesRank.toLocaleString() : '-') + '</td>';
    html += '<td class="p-3 text-right text-gray-500">' + (k.competitorCount ?? '-') + '</td></tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
async function loadPricing() {
  const container = document.getElementById('pricing-container');
  container.innerHTML = '<p class="p-6 text-gray-500">Loading...</p>';
  try {
    const res = await fetch('/api/v1/profit');
    const { data } = await res.json();
    profitData = data.items;
    document.getElementById('p-withcosts').textContent = data.summary.withCosts + '/' + data.summary.totalListings;
    document.getElementById('p-profitable').textContent = data.summary.profitable;
    document.getElementById('p-unprofitable').textContent = data.summary.unprofitable;
    document.getElementById('p-avgmargin').textContent = data.summary.avgMargin + '%';
    renderPricing();
  } catch (e) { container.innerHTML = '<p class="p-6 text-red-500">' + e.message + '</p>'; }
}
function renderPricing() {
  const container = document.getElementById('pricing-container');
  if (!profitData.length) { container.innerHTML = '<p class="p-6 text-gray-500">No listings.</p>'; return; }
  let html = '<table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="p-3 text-left">Product</th><th class="p-3 text-right">Price</th><th class="p-3 text-right">Cost</th><th class="p-3 text-right">Fees</th><th class="p-3 text-right">Profit</th><th class="p-3 text-right">Margin</th><th class="p-3 text-center">Action</th></tr></thead><tbody>';
  profitData.forEach(item => {
    const profitClass = item.profit > 0 ? 'text-green-600' : item.profit < 0 ? 'text-red-600' : 'text-gray-500';
    const marginClass = item.margin >= 20 ? 'text-green-600' : item.margin >= 10 ? 'text-yellow-600' : item.margin > 0 ? 'text-orange-600' : 'text-red-600';
    const costDisplay = item.hasCost ? '£' + item.cost.toFixed(2) : '<span class="text-gray-400">Not set</span>';
    html += '<tr class="border-t hover:bg-gray-50">';
    html += '<td class="p-3 max-w-xs truncate">' + (item.title || '').substring(0, 40) + '</td>';
    html += '<td class="p-3 text-right">£' + (item.price || 0).toFixed(2) + '</td>';
    html += '<td class="p-3 text-right">' + costDisplay + '</td>';
    html += '<td class="p-3 text-right text-gray-500">£' + item.fees.toFixed(2) + '</td>';
    html += '<td class="p-3 text-right font-medium ' + profitClass + '">£' + item.profit.toFixed(2) + '</td>';
    html += '<td class="p-3 text-right font-medium ' + marginClass + '">' + item.margin + '%</td>';
    html += '<td class="p-3 text-center"><button onclick="editCost(\'' + item.sku.replace(/'/g, "\\'") + '\')" class="text-blue-600 hover:underline text-xs">Edit Cost</button></td></tr>';
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
async function editCost(sku) {
  document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
  document.getElementById('page-cost-edit').classList.remove('hidden');
  const container = document.getElementById('cost-edit-container');
  container.innerHTML = '<p class="text-gray-500">Loading...</p>';
  try {
    const [profitRes, costRes] = await Promise.all([
      fetch('/api/v1/profit/' + encodeURIComponent(sku)),
      fetch('/api/v1/costs/' + encodeURIComponent(sku))
    ]);
    const profit = (await profitRes.json()).data;
    const cost = (await costRes.json()).data || {};
    let html = '<div class="max-w-2xl"><div class="bg-white rounded border p-6 mb-6">';
    html += '<h2 class="text-xl font-bold mb-2">' + (profit.title || '').substring(0, 60) + '</h2>';
    html += '<p class="text-sm text-gray-500 mb-4">SKU: ' + profit.sku + '</p>';
    html += '<div class="grid grid-cols-3 gap-4 mb-6">';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">Selling Price</p><p class="font-medium">£' + profit.sellingPrice.toFixed(2) + '</p></div>';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">Buy Box</p><p class="font-medium">£' + (profit.buyBoxPrice || 0).toFixed(2) + '</p></div>';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">Amazon Fees</p><p class="font-medium">£' + profit.fees.total.toFixed(2) + '</p></div>';
    html += '</div></div>';
    html += '<div class="bg-white rounded border p-6 mb-6"><h3 class="font-semibold mb-4">Enter Your Costs</h3>';
    html += '<div class="grid grid-cols-2 gap-4">';
    html += '<div><label class="block text-sm font-medium mb-1">Product Cost (£)</label><input type="number" step="0.01" id="cost-product" value="' + (cost.productCost || '') + '" class="w-full border rounded px-3 py-2"></div>';
    html += '<div><label class="block text-sm font-medium mb-1">Shipping Cost (£)</label><input type="number" step="0.01" id="cost-shipping" value="' + (cost.shippingCost || '') + '" class="w-full border rounded px-3 py-2"></div>';
    html += '<div><label class="block text-sm font-medium mb-1">Packaging Cost (£)</label><input type="number" step="0.01" id="cost-packaging" value="' + (cost.packagingCost || '') + '" class="w-full border rounded px-3 py-2"></div>';
    html += '<div><label class="block text-sm font-medium mb-1">Other Costs (£)</label><input type="number" step="0.01" id="cost-other" value="' + (cost.otherCost || '') + '" class="w-full border rounded px-3 py-2"></div>';
    html += '</div>';
    html += '<button onclick="saveCost(\'' + sku.replace(/'/g, "\\'") + '\')" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">Save Costs</button>';
    html += '<span id="cost-save-msg" class="ml-3 text-sm"></span></div>';
    html += '<div class="bg-white rounded border p-6"><h3 class="font-semibold mb-4">Profit Calculation</h3>';
    html += '<div class="grid grid-cols-2 gap-4">';
    html += '<div class="p-4 bg-green-50 rounded border border-green-200"><p class="text-sm text-green-700">Gross Profit</p><p class="text-2xl font-bold text-green-700">£' + profit.profit.gross.toFixed(2) + '</p></div>';
    html += '<div class="p-4 bg-blue-50 rounded border border-blue-200"><p class="text-sm text-blue-700">Margin</p><p class="text-2xl font-bold text-blue-700">' + profit.profit.margin + '%</p></div>';
    html += '</div>';
    if (profit.atBuyBox) {
      html += '<p class="mt-4 text-sm text-gray-500">At Buy Box price (£' + profit.buyBoxPrice.toFixed(2) + '): £' + profit.atBuyBox.gross.toFixed(2) + ' profit (' + profit.atBuyBox.margin + '% margin)</p>';
    }
    html += '</div></div>';
    container.innerHTML = html;
  } catch (e) { container.innerHTML = '<p class="text-red-500">' + e.message + '</p>'; }
}
async function saveCost(sku) {
  const msg = document.getElementById('cost-save-msg');
  try {
    await fetch('/api/v1/costs/' + encodeURIComponent(sku), {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        productCost: document.getElementById('cost-product').value,
        shippingCost: document.getElementById('cost-shipping').value,
        packagingCost: document.getElementById('cost-packaging').value,
        otherCost: document.getElementById('cost-other').value
      })
    });
    msg.className = 'ml-3 text-sm text-green-600';
    msg.textContent = 'Saved!';
    editCost(sku); // Refresh to show updated profit
  } catch (e) { msg.className = 'ml-3 text-sm text-red-600'; msg.textContent = e.message; }
}
async function showDetail(sku) {
  document.querySelectorAll('[id^="page-"]').forEach(p => p.classList.add('hidden'));
  document.getElementById('page-detail').classList.remove('hidden');
  const container = document.getElementById('detail-container');
  container.innerHTML = '<p class="text-gray-500">Loading...</p>';
  try {
    const res = await fetch('/api/v1/listings/' + encodeURIComponent(sku));
    const { data } = await res.json();
    const { listing, score } = data;
    const k = keepaData[listing.asin] || {};
    let html = '<div class="bg-white rounded border p-6 mb-6"><div class="flex justify-between items-start mb-4"><div class="flex-1 mr-4"><h2 class="text-xl font-bold mb-2">' + (listing.title || 'Unknown') + '</h2><p class="text-sm text-gray-500">SKU: ' + listing.sku + ' | ASIN: ' + listing.asin + '</p></div>';
    if (score) {
      const scc = score.totalScore >= 80 ? 'bg-green-500' : score.totalScore >= 60 ? 'bg-yellow-500' : 'bg-red-500';
      html += '<div class="text-center"><div class="w-20 h-20 rounded-full ' + scc + ' flex items-center justify-center"><span class="text-2xl font-bold text-white">' + score.totalScore + '</span></div><p class="text-sm text-gray-500 mt-1">Score</p></div>';
    }
    html += '</div><div class="grid grid-cols-5 gap-4">';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">Your Price</p><p class="font-medium">£' + (listing.price || 0).toFixed(2) + '</p></div>';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">Buy Box</p><p class="font-medium">' + (k.buyBoxPrice ? '£' + k.buyBoxPrice.toFixed(2) : '-') + '</p></div>';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">BSR</p><p class="font-medium">' + (k.salesRank ? '#' + k.salesRank.toLocaleString() : '-') + '</p></div>';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">Rating</p><p class="font-medium">' + (k.rating ? k.rating + '/5' : '-') + '</p></div>';
    html += '<div class="p-3 bg-gray-50 rounded"><p class="text-xs text-gray-500">Competitors</p><p class="font-medium">' + (k.competitorCount ?? '-') + '</p></div>';
    html += '</div></div>';
    if (score) {
      // Show all 5 scoring components
      html += '<div class="grid grid-cols-5 gap-4 mb-6">';
      ['seo', 'content', 'images', 'competitive', 'compliance'].forEach(cat => {
        const c = score.components?.[cat] || { score: 50 };
        const col = c.score >= 80 ? 'text-green-600' : c.score >= 60 ? 'text-yellow-600' : 'text-red-600';
        const labels = { seo: 'SEO', content: 'Content', images: 'Images', competitive: 'Competitive', compliance: 'Compliance' };
        html += '<div class="bg-white rounded border p-4 text-center"><p class="text-sm text-gray-500">' + labels[cat] + '</p><p class="text-2xl font-bold ' + col + '">' + c.score + '</p>';
        if (cat === 'compliance' && c.violations?.length > 0) {
          html += '<p class="text-xs text-red-500">' + c.violations.length + ' issue(s)</p>';
        }
        if (cat === 'competitive' && !c.dataAvailable) {
          html += '<p class="text-xs text-gray-400">No Keepa data</p>';
        }
        html += '</div>';
      });
      html += '</div>';

      // Compliance violations detail
      if (score.components?.compliance?.violations?.length > 0) {
        html += '<div class="bg-red-50 border border-red-200 rounded p-4 mb-6"><h4 class="font-semibold text-red-800 mb-2">⚠️ Compliance Issues Found</h4><div class="space-y-1">';
        score.components.compliance.violations.forEach(v => {
          const sevCol = v.severity === 'critical' ? 'bg-red-600' : v.severity === 'high' ? 'bg-red-500' : v.severity === 'medium' ? 'bg-yellow-500' : 'bg-gray-400';
          html += '<div class="flex items-center gap-2 text-sm"><span class="px-2 py-0.5 rounded text-xs text-white ' + sevCol + '">' + v.severity + '</span><span class="font-medium">"' + v.term + '"</span><span class="text-gray-500">(' + v.category + ')</span></div>';
        });
        html += '</div></div>';
      }

      // Competitive analysis detail
      if (score.components?.competitive?.dataAvailable && score.components?.competitive?.analysis) {
        const ca = score.components.competitive.analysis;
        html += '<div class="bg-blue-50 border border-blue-200 rounded p-4 mb-6"><h4 class="font-semibold text-blue-800 mb-2">📊 Competitive Analysis</h4><div class="grid grid-cols-5 gap-4 text-sm">';
        html += '<div><p class="text-gray-500">Buy Box</p><p class="font-medium">' + (ca.buyBoxPrice ? '£' + ca.buyBoxPrice.toFixed(2) : '-') + '</p></div>';
        html += '<div><p class="text-gray-500">BSR</p><p class="font-medium">' + (ca.bsr ? '#' + ca.bsr.toLocaleString() : '-') + '</p></div>';
        html += '<div><p class="text-gray-500">Sellers</p><p class="font-medium">' + (ca.offerCount || '-') + '</p></div>';
        html += '<div><p class="text-gray-500">Rating</p><p class="font-medium">' + (ca.rating ? ca.rating + '/5' : '-') + '</p></div>';
        html += '<div><p class="text-gray-500">Reviews</p><p class="font-medium">' + (ca.reviewCount ? ca.reviewCount.toLocaleString() : '-') + '</p></div>';
        html += '</div></div>';
      }

      if (score.recommendations?.length) {
        html += '<div class="bg-white rounded border p-6"><h3 class="font-semibold mb-4">Recommendations (' + score.recommendations.length + ')</h3><div class="space-y-3">';
        score.recommendations.slice(0, 10).forEach(r => {
          const pc = r.priority === 'critical' ? 'bg-purple-100 text-purple-800' : r.priority === 'high' ? 'bg-red-100 text-red-800' : r.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800';
          const typeCol = { seo: 'text-blue-600', content: 'text-green-600', images: 'text-purple-600', competitive: 'text-orange-600', compliance: 'text-red-600' };
          html += '<div class="p-3 border rounded"><div class="flex items-center gap-2 mb-1"><span class="px-2 py-0.5 rounded text-xs ' + pc + '">' + r.priority + '</span><span class="text-xs ' + (typeCol[r.type] || 'text-gray-600') + '">[' + r.type + ']</span><span class="font-medium">' + r.title + '</span></div><p class="text-sm text-gray-600">' + r.description + '</p></div>';
        });
        html += '</div></div>';
      }
    }
    container.innerHTML = html;
  } catch (e) { container.innerHTML = '<p class="text-red-500">' + e.message + '</p>'; }
}
async function loadSettingsStatus() {
  try {
    const res = await fetch('/api/v1/settings');
    const { data } = await res.json();
    const el = document.getElementById('cred-status');
    el.className = data.configured ? 'mb-4 p-3 bg-green-100 rounded text-sm text-green-700' : 'mb-4 p-3 bg-yellow-100 rounded text-sm text-yellow-700';
    el.textContent = data.configured ? 'Connected: ' + data.clientIdPreview : 'Not configured';
  } catch (e) { console.error(e); }
}
async function saveSettings() {
  const btn = document.getElementById('btn-save'), msg = document.getElementById('save-msg');
  btn.disabled = true; btn.textContent = 'Saving...';
  try {
    await fetch('/api/v1/settings', { method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ clientId: document.getElementById('f-clientid').value, clientSecret: document.getElementById('f-secret').value, refreshToken: document.getElementById('f-token').value, keepaKey: document.getElementById('f-keepa').value })
    });
    msg.className = 'ml-3 text-sm text-green-600'; msg.textContent = 'Saved!';
    ['f-clientid','f-secret','f-token','f-keepa'].forEach(id => document.getElementById(id).value = '');
    loadSettingsStatus();
  } catch (e) { msg.className = 'ml-3 text-sm text-red-600'; msg.textContent = e.message; }
  btn.disabled = false; btn.textContent = 'Save';
}
loadDashboard();
</script>
<script src="/extra.js"></script></body>
</html>
